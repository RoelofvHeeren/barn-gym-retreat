<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retreat Summary - Barn Gym Retreats</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;800&family=Raleway:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="retreat-builder.css?v=2">
    <script src="scripts/booking-state.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: url('background-C1rXCpYp.png') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Raleway', sans-serif;
        }

        .barn-glass-card {
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 120px !important;
        }

        .form-group {
            margin-bottom: 25px;
        }
    </style>
</head>

<body>

    <div class="barn-glass-card barn-shadow-depth">
        <div class="logo-container">
            <img src="logo-D2Lb8pNx.png" alt="Barn Gym Logo">
        </div>

        <div class="step-hero" style="padding-bottom: 10px;">
            <h2>Your Itinerary</h2>
            <p>Review your custom retreat package.</p>
        </div>

        <!-- SUMMARY SECTION -->
        <div class="summary-box">
            <div class="summary-header">
                <div id="summary-thumb" class="summary-thumb" style="background-color: #ddd;"></div>
                <div>
                    <h3 id="summary-venue">Venue Name</h3>
                    <p id="summary-details">12 Guests • 3 Days / 2 Nights</p>
                </div>
            </div>

            <div class="itinerary-container" id="itinerary-list">
                <!-- Dynamic activities list -->
            </div>

            <div style="margin-top: 20px; font-weight: bold; color: var(--color-primary); font-size: 1.1rem;">
                Estimated Total: <span id="est-price">£5,000 - £7,000</span>
            </div>
        </div>

        <!-- CONTACT FORM -->
        <div style="margin-top: 30px;">
            <h3>Final Details</h3>
            <p style="margin-bottom: 15px; font-size: 0.9rem;">We'll send this proposal to your inbox.</p>

            <div class="flex-row">
                <div class="flex-col form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="contact-name" class="form-input" placeholder="Jane Doe">
                </div>
                <div class="flex-col form-group">
                    <label class="form-label">Company</label>
                    <input type="text" id="contact-company" class="form-input" placeholder="Acme Inc.">
                </div>
            </div>
            <div class="flex-row">
                <div class="flex-col form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="contact-email" class="form-input" placeholder="jane@acme.com">
                </div>
                <div class="flex-col form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" id="contact-phone" class="form-input" placeholder="+44 7700 900000">
                </div>
            </div>
        </div>

        <!-- Sticky Footer (Step 4 of 4) -->
        <div class="sticky-footer visible">
            <div class="footer-content">
                <a href="/activities" class="btn btn-secondary">Back</a>
                <span id="footer-progress">Step 4 of 4</span>
                <button id="btn-submit" class="btn" onclick="submitProposal()">Request Proposal</button>
            </div>
        </div>
    </div>

    <script>
        const state = getBookingState();

        // Render Summary
        document.getElementById('summary-venue').innerText = state.location || 'No Venue Selected';
        document.getElementById('summary-details').innerText = `${state.guestCount} Guests • ${state.duration} • ${state.month}`;

        // Thumb image
        if (state.locationId) {
            // Simple map for thumb
            const imgMap = {
                'bell': 'Retreat Images/The Bell/The Bell 1.webp',
                'oastbrook': 'Retreat Images/Oastbrook/Oastbrook 1.avif',
                'eastwood': 'Retreat Images/Eastwood/Eastwood 1.webp'
            };
            const url = imgMap[state.locationId];
            if (url) document.getElementById('summary-thumb').style.backgroundImage = `url('${url}')`;
        }

        // Itinerary Logic
        const list = document.getElementById('itinerary-list');
        const selected = state.activities || [];

        if (selected.length > 0) {
            // Distribute activities across 3 days
            // Day 1: Arrive, 1st activity
            // Day 2: Main activities (bulk)
            // Day 3: Morning activity, Depart

            const day1 = [];
            const day2 = [];
            const day3 = [];

            selected.forEach((act, index) => {
                if (index === 0) day1.push(act);
                else if (index === selected.length - 1 && selected.length > 2) day3.push(act);
                else day2.push(act);
            });

            let itineraryHtml = '';

            // Day 1
            itineraryHtml += `
                <div class="day-row">
                    <div class="day-title">Day 1: Arrival & Grounding</div>
                    <div class="day-content">
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Arrival & Welcome Refreshments</li>
                            ${day1.map(a => `<li><strong>${a}</strong></li>`).join('')}
                            <li>Team Welcome Dinner</li>
                        </ul>
                    </div>
                </div>
            `;

            // Day 2
            itineraryHtml += `
                <div class="day-row">
                    <div class="day-title">Day 2: Deep Work & Team Building</div>
                    <div class="day-content">
                        <ul style="margin: 0; padding-left: 20px;">
                            ${day2.length > 0 ? day2.map(a => `<li><strong>${a}</strong></li>`).join('') : '<li>Strategic Workshop Session</li>'}
                            <li>Group Farm-to-Table Lunch</li>
                            <li>Evening Relaxation & Firepit Bonding</li>
                        </ul>
                    </div>
                </div>
            `;

            // Day 3
            itineraryHtml += `
                <div class="day-row">
                    <div class="day-title">Day 3: Reflection & Departure</div>
                    <div class="day-content">
                        <ul style="margin: 0; padding-left: 20px;">
                            ${day3.length > 0 ? day3.map(a => `<li><strong>${a}</strong></li>`).join('') : '<li>Morning Movement & Breakfast</li>'}
                            <li>Closing Workshop & Goal Setting</li>
                            <li>Departure</li>
                        </ul>
                    </div>
                </div>
            `;

            list.innerHTML = itineraryHtml;
        } else {
            list.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">No specific activities selected. We will propose a balanced "Relaxation & Strategy" itinerary for you.</p>';
        }

        /* Add CSS for day-row on the fly if missing or ensure it's in CSS */

        // Interactive Submit
        async function submitProposal() {
            const btn = document.getElementById('btn-submit');
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;

            if (!name || !email) {
                alert('Please enter your name and email.');
                return;
            }

            btn.innerText = 'Sending...';
            btn.disabled = true;

            // Calculate Opportunity Value (Low End)
            let opportunityValue = 0;
            const priceText = document.getElementById('est-price').innerText;
            const match = priceText.match(/£([\d,]+)/);
            if (match) {
                opportunityValue = parseInt(match[1].replace(/,/g, ''), 10);
            }

            // Generate Plain Text Itinerary
            let itineraryText = '';
            const selected = state.activities || [];
            if (selected.length > 0) {
                const day1 = [];
                const day2 = [];
                const day3 = [];
                selected.forEach((act, index) => {
                    if (index === 0) day1.push(act);
                    else if (index === selected.length - 1 && selected.length > 2) day3.push(act);
                    else day2.push(act);
                });

                itineraryText += "Day 1: Arrival, " + day1.join(', ') + ", Dinner\n";
                itineraryText += "Day 2: Breakfast, " + day2.join(', ') + ", Lunch, Dinner\n";
                itineraryText += "Day 3: Breakfast, " + day3.join(', ') + ", Departure";
            } else {
                itineraryText = "Relaxation & Strategy Itinerary (No specific activities selected)";
            }

            // Prepare Payload
            const payload = {
                companyName: document.getElementById('contact-company').value || 'N/A',
                venueName: state.location,
                guestCount: state.guestCount,
                duration: state.duration,
                month: state.month,
                activities: state.activities,
                contactName: name,
                contactEmail: email,
                contactPhone: document.getElementById('contact-phone').value,
                opportunityValue: opportunityValue,
                itineraryText: itineraryText
            };

            try {
                const response = await fetch('/api/booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Success
                    clearBookingState(); // Optional: clear state after success
                    window.location.href = '/thank-you';
                } else {
                    throw new Error('API Error');
                }
            } catch (e) {
                console.error(e);
                alert('Something went wrong. Please try again.');
                btn.innerText = 'Request Proposal';
                btn.disabled = false;
            }
        }
    </script>

</body>

</html>